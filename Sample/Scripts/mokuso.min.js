"use strict"; !function () { var _ = new (kendo.Class.extend({ isArray: function (e) { return e && $.isArray(e) ? !0 : e && kendo.isFunction(e.shift) && kendo.isFunction(e.slice) ? !0 : !1 }, isObservableObject: function (e) { return e && "string" == $.type(e.uid) && kendo.isFunction(e.get) && kendo.isFunction(e.set) ? !0 : !1 }, handleModuleHook: function (e, n, t) { for (var o = [], r = 0; r < e.length; r++) $.isFunction(e[r][n]) && o.push(e[r][n].apply(e[r][n], t || [])); return $.when.apply(null, o) }, findNestedViews: function findNestedViews(_node, _parentModel, _renderer) { var _defs = []; return _node.find("*[data-role='mokusoview']").addBack("*[data-role='mokusoview']").each(function (i, n) { var _n = $(n), _view = _n.attr("data-view"), _args = new kendo.data.ObservableObject({}); if ($.trim(_n.attr("data-view-args")).length) { var arrBindFields = [], __args = {}; if (_parentModel) try { eval("__args = " + _n.attr("data-view-args").replace(new RegExp(":\\s?([a-zA-Z_]{1,})", "gi"), ": _parentModel.$1")) } catch (ex) { console.error("Argument Parsing Error", "Could not parse inline page arguments: " + _n.attr("data-view-args")) } for (var fProp in __args) { var _type = $.type(__args[fProp]); if ("string" == _type || "number" == _type || "object" == _type) _args.set(fProp, __args[fProp]); else for (var tProp in _parentModel) if (__args[fProp] === _parentModel[tProp]) { arrBindFields.push({ f: fProp, t: tProp }), _args.set(fProp, _parentModel.get(tProp)); break } } arrBindFields.length && _parentModel.bind("change", function (e) { for (var n = 0; n < arrBindFields.length; n++) if (arrBindFields[n].t == e.field) { _args.set(arrBindFields[n].t, this.get(e.field)); break } }) } _defs.push(_renderer.render(_n, _view, _args)) }), $.when.apply($, _defs) }, createRenderer: function (e, n, t) { var o = $.type(e); if ("function" == o) { if (e = new e(n, t), e instanceof _renderer) return e } else if ("string" == $.type(e)) switch (e.toLowerCase()) { case "kendomobile": return new _renderer_KendoMobile(n, t); case "react": return new _renderer_React(n, t); case "knockout": return new _renderer_Knockout(n, t) } return new _renderer_Kendo(n, t) }, createResolver: function (e, n) { var t = $.type(e); if ("function" == t) { if (e = new e(n), e instanceof _resolver) return e } else if ("string" == $.type(e)) switch (e.toLowerCase()) { case "browserify": return new _renderer_Browserify(n) } return new _resolver_RequireJS(n) } })), _renderer = kendo.Class.extend({ options: {}, resolver: null, init: function (e, n) { this.options = e, this.resolver = n }, render: function (e, n, t) { }, destroy: function (e) { } }), _renderer_Kendo = _renderer.extend({ render: function (e, n, t) { if (!("string" != $.type(n) || $.trim(n).length <= 0 || "object" != $.type(e))) { var o = this, r = $.Deferred(), i = n.indexOf("?"), s = i > 0 ? n.substring(0, i) : n, a = _.isObservableObject(t) ? t : new kendo.data.ObservableObject($.isPlainObject(t) ? t : {}), l = e; e instanceof $ || (l = $(e)); var d = o.resolver.resolve(o.options.paths.view + "/" + s + ".html"); return this.resolver.resolve(this.options.paths.viewmodel + "/" + s + ".js").then(function (e) { var n = kendo.observable($.extend(!0, { preinit: function (e, n) { }, init: function (e, n) { }, __________init: function (e) { return this.init(e.view.element, e.sender.params) }, deinit: function (e) { } }, e)); d.then(function (e) { return o._wireTogether(l, s, a, e, n, r) }).fail(function () { r.rejectWith(null, arguments) }) }).fail(function () { r.rejectWith(null, arguments) }), r } }, destroy: function (e) { var n = null, t = e.find("*[data-role='mokusoview']"); if (e.data("mokusoView") && t.push(e), t.length) { var o = $.Deferred(); n = $.Deferred(); var r = $.map(t, function (e) { var n = $(e); return { depth: n.parents().length, node: n } }).sort(function (e, n) { return n.depth - e.depth }).reduce(function (e, n, t, o) { return e.then(function () { return n.node.data("mokusoView").model.deinit(n.node) }) }, o); r.then(function () { e.data("mokusoView") && e.data("mokusoView").destroy(), e.empty(), n.resolve() }).fail(function () { n.reject() }), o.resolve() } return null === n && (n = $.Deferred().resolve()), n }, _initView: function (e, n) { var t = this; return $.when(e.model.init(e.element, n)).then(function () { return _.findNestedViews(e.element.children(), e.model, t) }) }, _wireTogether: function (e, n, t, o, r, i) { var s = this, a = new kendo.View("<div>" + o + "</div>", { model: r, init: function () { this.element.data("mokusoView", this), this.element.attr("data-role", "mokusoview"), this.element.attr("data-view", n) }, show: function (e) { return s.options.transition && e.sender.element.closest(s.options.node).length && e.sender.element.siblings("[data-role=mokusoview]").length ? void 0 : s._initView(this, t).then(function () { i.resolve() }).fail(function () { i.rejectWith(null, arguments) }) }, transitionStart: function (n) { n.sender.element.data("_prevHeight", n.sender.element.css("height")).data("_prevWidth", n.sender.element.css("width")), n.sender.element.height(e.height()).width(e.width()) }, transitionEnd: function (e) { if (e.sender.element.css("height", e.sender.element.data("_prevHeight")).css("width", e.sender.element.data("_prevWidth")), "hide" != e.type || e.sender.___destroying) { if ("show" == e.type && s.options.transition) { var n = this; setTimeout(function () { s._initView(n, t).then(function () { i.resolve() }).fail(function () { i.rejectWith(null, arguments) }) }, 250) } } else e.sender.___destroying = !0, setTimeout(function () { s.destroy(e.sender.element) }, 250) }, hide: function (e) { e.sender.___destroying || (e.sender.___destroying = !0, s.destroy(e.sender.element)) }, wrap: !1 }); return $.when(r.preinit(e, t)).then(function () { e.removeAttr("data-role"), e.removeAttr("data-view"), e.removeAttr("data-view-args"); var n = e.parents("*[data-role^='mokuso']:first").data("mokusoLayout"); n instanceof kendo.Layout ? n.showIn("#mokusoLayoutNode", a, s.options.transition) : a.render(e) }) } }), _renderer_KendoMobile = _renderer_Kendo.extend({ _wireTogether: function (e, n, t, o, r, i) { var s = this; if (e.parent().is("[data-mokuso-content-node]")) { var a = $(o), l = "a" + kendo.guid().replace(new RegExp("-", "g"), ""); return Class.GlobalMobileModels[l] = r, a.each(function (e) { var n = $(this), t = $.trim(n.attr("data-role") || "").toLowerCase(); if (t.length && (n.attr("data-model", "mokuso.GlobalMobileModels." + l), "view" == t)) { var o = (n.attr("data-bind") || "").replace(new RegExp("events([ ]{0,}):([ ]{0,}){", "i"), "events:{"), r = o.indexOf("events:{"); r > -1 ? n.attr("data-bind", o.substring(0, r + 8) + " init: __________init, " + o.substring(r + 8, o.length)) : n.attr("data-bind", $.merge(o.length ? o.split(",") : [], ["events: { init: __________init }"]).join(",")) } }), $.when(r.preinit(e, t)).then(function () { var n = a.insertAfter(e); return _.findNestedViews(n, r, s).then(function () { i.resolve() }).fail(function () { i.rejectWith(null, arguments) }) }) } return _renderer_Kendo.fn._wireTogether.apply(s, arguments) } }), _renderer_React = _renderer.extend({ render: function (e, n, t) { var o = $.Deferred(); return this.resolver.resolve(this.options.paths.view + "/" + n + ".js").then(function (n) { React.unmountComponentAtNode(e[0]), React.render(n, e[0], function () { o.resolve() }) }).fail(function () { o.rejectWith(null, arguments) }), o } }), _renderer_Knockout = _renderer.extend({ render: function (e, n, t) { var o = $.Deferred(); return $.when(this.resolver.resolve(this.options.paths.view + "/" + n + ".html"), this.resolver.resolve(this.options.paths.viewmodel + "/" + n + ".js")).then(function (n, t) { for (var o in t) _.isArray(t[o]) ? t[o] = ko.observableArray(t[o]) : $.isFunction(t[o]) || (t[o] = ko.observable(t[o])); ko.cleanNode(e[0]), e.html(n), ko.applyBindings(t, e[0]) }).fail(function () { o.rejectWith(null, arguments) }), o } }), _resolver = kendo.Class.extend({ options: null, init: function (e) { this.options = e }, resolve: function (e) { throw "resolver didnt provide a resolve method." } }), _resolver_JQuery = _resolver.extend({ resolve: function (e) { var n = null; return n = e.match("js$") ? $.ajax({ url: e, dataType: "script" }).promise() : $.ajax({ url: e }).promise() } }), _resolver_RequireJS = _resolver.extend({ cache: {}, resolve: function (e) { var n = null; if (e.match("js$")) n = $.Deferred(), require([e.replace(new RegExp(".js$"), "")], function (e) { n.resolveWith(null, [e]) }, function () { n.rejectWith(null, arguments) }); else if (this.cache[e]) n = $.Deferred().resolveWith(null, [this.cache[e]]); else { var t = this; n = $.ajax({ url: require.toUrl(e), success: function (n) { t.cache[e] = n } }).promise() } return n } }), _resolver_Browserify = _resolver.extend({ resolve: function (e) { var n = null; return n = e.match(".js$") ? $.Deferred().resolveWith(null, [require(e.replace(new RegExp(".js$"), ""))]) : $.ajax({ url: e }).promise() } }), Class = kendo.Class.extend({ options: {}, events: ["init", "before-navigate", "after-navigate", "before-load", "after-load"], router: null, mobileApp: null, modules: [], _events: $({}), _renderer: null, _resolver: null, init: function (e, n, t) { var o = this; this.options = $.extend({ node: $("body"), initial: null, init: null, transition: "swap", root: "/", pushState: !1, hashBang: !1, modules: [], paths: { view: "view", viewmodel: "viewmodel" }, renderer: "kendo", resolver: "requirejs" }, n), e && (e instanceof $ || (e = $(e)), this.options.node = e); for (var r = 0; r < this.options.modules.length; r++) this.registerModule(this.options.modules[r]); o._resolver = _.createResolver(o.options.resolver, o.options), o._renderer = _.createRenderer(o.options.renderer, o.options, o._resolver), _.handleModuleHook(this.modules, "beforeInit", [this]).then(function () { if (o.options.node.attr("data-mokuso-content-node", !0), t && kendo.mobile && kendo.mobile.Application) { var r = $.Deferred(), i = _.createRenderer("kendomobile", o.options, o._resolver); return o.options.transition && "swap" !== o.options.transition.toLowerCase() || (o.options.transition = "slide"), "string" == $.type(o.options.initial) && $.trim(o.options.initial).length > 0 ? o.load(o.options.node, n.initial, {}, i).then(function () { o.options.node.prepend(o.options.node.find(">*[data-role='mokusoview']").data("mokusoView").element.children()), o.mobileApp = new kendo.mobile.Application(o.options.node, $.extend($.extend({}, o.options), { initial: null, init: function () { setTimeout(function () { r.resolve() }, 10) } })) }) : _.findNestedViews(o.options.node, null, i).then(function () { o.mobileApp = new kendo.mobile.Application(o.options.node, $.extend($.extend({}, o.options), { init: function () { setTimeout(function () { r.resolve() }, 10) } })) }), $.when(r).then(function () { o.router = o.mobileApp.router, kendo.ui.progress = function (e, n) { var t = kendo.widgetInstance(e.closest(".km-pane").addBack(".km-pane")); t && t.loader ? (n ? t.loader.show() : t.loader.hide(), n || t.element.find(".k-loading-mask").remove()) : (n ? o.mobileApp.showLoading() : o.mobileApp.hideLoading(), n || o.options.node.find(".k-loading-mask").remove()) }, o.router.bind("change", function (e) { o.trigger("before-navigate", [e.url, o.options.node]), _.handleModuleHook(o.modules, "beforeNavigate", [o.options.node, e.url]), setTimeout(function () { o.trigger("after-navigate", [e.url, o.options.node]), _.handleModuleHook(o.modules, "afterNavigate", [o.options.node, e.url]) }, 10) }) }) } o.router = new kendo.Router({ pushState: o.options.pushState, hashBang: o.options.hasBang, root: o.options.root }), o.router.route("*page", function (e, n) { _.handleModuleHook(o.modules, "beforeNavigate", [o.options.node, e, n]).then(function () { o.trigger("before-navigate", [e, o.options.node]), $.when(o._renderer.render(o.options.node, e, n)).fail(function (e) { o.router.trigger("routeMissing", e) }).then(function () { o.trigger("after-navigate", [e, o.options.node]) }) }).then(function () { return _.handleModuleHook(o.modules, "afterNavigate", [o.options.node, e, n]) }) }); var s = new kendo.Layout("<div id='mokusoLayoutNode'></div>", { wrap: !1 }); s.render(e), o.options.node = e.find("#mokusoLayoutNode"), e.attr("data-role", "mokusolayout"), e.data("mokusoLayout", s); var a = location.href.indexOf("#"); $.trim(o.options.initial).length && (0 > a || a == location.href.length - 1) && (0 > a ? location.href = location.href + "#" + o.options.initial : location.href = location.href.substring(0, a) + "#" + o.options.initial) }).then(function () { return _.handleModuleHook(o.modules, "afterInit", [o]).then(function () { o.mobileApp || o.router.start(), $.isFunction(o.options.init) && o.options.init(o) }) }) }, registerModule: function (e) { e instanceof Class.Module && 0 === $.grep(this.modules, function (n) { return e === n }).length ? this.modules.push(e) : console.error("Module is not an extension of mokuso.Module") }, deregisterModule: function (e) { e instanceof Class.Module && $.grep(this.modules, function (n) { return e === n }).length >= 1 ? this.modules = $.grep(function (n) { return e !== n }) : console.error("Module is not an extension of mokuso.Module") }, navigate: function (e, n) { return this.router ? "string" == $.type(e) && $.trim(e).length > 0 ? this.mobileApp ? this.mobileApp.navigate.apply(this.mobileApp, arguments) : this.router.navigate.apply(this.router, arguments) : void console.error("Arguments Exception", "Page is empty; Usage: navigate(String page)") : void console.error("App not initialized: call initialize(DomNode contentNode, JSON options)") }, replace: function (e) { return this.router ? "string" == $.type(e) && $.trim(e).length > 0 ? this.mobileApp ? this.mobileApp.replace.apply(this.mobileApp, arguments) : this.router.replace.apply(this.router, arguments) : void console.error("Arguments Exception", "Page is empty; Usage: replace(String page)") : void console.error("App not initialized: call initialize(DomNode contentNode, JSON options)") }, load: function (e, n, t, o) { var r = this, i = this._renderer; return (o instanceof _renderer || o instanceof _renderer_Kendo) && (i = o), "string" == $.type(n) && $.trim(n).length > 0 && "object" == $.type(e) ? _.handleModuleHook(this.modules, "beforeLoad", [e, n, t]).then(function () { return r.trigger("before-load", [e, n, t]), $.when(i.render.apply(i, [e, n, t])).fail(function () { console.error("mokuso error loading", arguments) }) }).then(function () { return _.handleModuleHook(r.modules, "afterLoad", [e, n, t]).then(function () { r.trigger("after-load", [e, n, t]) }) }) : void console.error("Arguments Exception", "Page is empty or node is not a DOM element; Usage: load(String page, DomNode node)") }, showLoading: function () { this.mobileApp ? this.mobileApp.showLoading() : kendo.ui.progress(this.options.node, !0) }, hideLoading: function () { kendo.ui.progress(this.options.node, !1), this.mobileApp && this.mobileApp.hideLoading() }, bind: function (e, n) { "string" == $.type(e) && $.trim(e).length > 0 && $.isFunction(n) ? this.mobileApp ? this.mobileApp.bind.apply(this.mobileApp, arguments) : this._events.bind.apply(this._events, arguments) : console.error("Arguments Exception", "Event is empty or method is not a function; Usage: bind(String event, Function method, ...)") }, trigger: function (e) { "string" == $.type(e) && $.trim(e).length > 0 ? this.mobileApp ? this.mobileApp.trigger.apply(this.mobileApp, arguments) : this._events.trigger.apply(this._events, arguments) : console.error("Arguments Exception", "Event is empty ; Usage: bind(String event, ...)") } }); kendo.isArray = _.isArray, kendo.isObservableObject = _.isObservableObject, kendo.mobile && (kendo.mobile.isArray = _.isArray, kendo.mobile.isObservableObject = _.isObservableObject), Class.Renderer = _renderer, Class.Resolver = _resolver, Class.Module = kendo.Class.extend({ beforeInit: function (e) { }, afterInit: function (e) { }, beforeNavigate: function (e, n, t) { }, afterNavigate: function (e, n, t) { }, beforeLoad: function (e, n, t) { }, afterLoad: function (e, n, t) { } }), Class.GlobalMobileModels = {}, window.mokuso = Class, "function" == typeof define && define.amd ? define(function () { return Class }) : "undefined" != typeof module && module.exports && (module.exports = Class) }();